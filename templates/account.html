{% extends "base.html" %}
{% block title %}Account Setup{% endblock %}

{% block content %}
<style>
    :root {
        --primary-green: #2d6a4f;
        --secondary-green: #40916c;
        --light-green: #52b788;
        --lighter-green: #b7e4c7;
        --very-light-green: #d8f3dc;
    }
    
    .account-container {
        max-width: 500px;
        margin: 2rem auto;
        padding: 2rem;
        background-color: white;
        border-radius: 12px;
        border: 2px solid var(--very-light-green);
        box-shadow: 0 2px 8px rgba(45, 106, 79, 0.06);
    }
    
    .account-container h3 {
        color: var(--primary-green);
        font-weight: 600;
        margin-bottom: 2rem;
        text-align: center;
        font-size: 1.5rem;
    }
    
    .edit-button-container {
        text-align: center;
        margin-bottom: 2rem;
        display: flex;
        gap: 1rem;
        justify-content: center;
    }
    
    .edit-button-container .btn {
        padding: 0.7rem 1.5rem;
        border-radius: 6px;
        font-weight: 500;
    }
    
    .form-disabled {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .form-enabled {
        opacity: 1;
        pointer-events: auto;
    }
    
    .form-group label {
        color: var(--text-dark);
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    
    .form-text {
        color: #888;
        font-size: 0.85rem;
    }
    
    .form-text.text-muted {
        color: #999;
    }
    
    .text-danger {
        color: #d64045 !important;
        font-weight: 500;
    }
    
    select.form-control {
        color: var(--text-dark) !important;
        background-color: white !important;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%232d6a4f' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px;
        padding-right: 2.5rem !important;
    }
    
    select.form-control option {
        color: var(--text-dark) !important;
        background-color: white !important;
        padding: 0.5rem;
    }
    
    select.form-control option:checked {
        background-color: var(--very-light-green) !important;
        color: var(--text-dark) !important;
    }
</style>

<div class="account-container">
            <h3>Account Information</h3>
            <div class="edit-button-container">
                <button type="button" class="btn btn-primary" id="editBtn" onclick="enableEditMode()" {% if is_first_setup %}style="display: none;"{% endif %}>Edit</button>
                <button type="button" class="btn btn-secondary" id="cancelBtn" onclick="disableEditMode()" {% if not is_first_setup %}style="display: none;"{% endif %}>Cancel</button>
            </div>
            <form method="POST" id="accountForm" enctype="multipart/form-data" {% if is_first_setup %}class="form-enabled"{% else %}class="form-disabled"{% endif %}>
                <div class="form-group">
                    <label for="name">Full Name</label>
                    <input
                        type="text"
                        class="form-control"
                        id="name"
                        name="name"
                        placeholder="Enter your full name"
                        value="{{ user.first_name or '' }}"
                        {% if not is_first_setup %}disabled{% endif %}
                        required
                    />
                    <small class="form-text text-muted">Required. At least 2 characters.</small>
                </div>

                <div class="form-group">
                    <label for="dateOfBirth">Date of Birth</label>
                    <input
                        type="date"
                        class="form-control"
                        id="dateOfBirth"
                        name="dateOfBirth"
                        {% if user.date_of_birth %}
                            value="{{ user.date_of_birth.isoformat() }}"
                        {% endif %}
                        {% if not is_first_setup %}disabled{% endif %}
                        required
                        onchange="validateAge()"
                    />
                    <small class="form-text text-muted">Required. You must be at least 18 years old.</small>
                    <div id="ageError" class="text-danger mt-2" style="display:none;">
                        You must be at least 18 years old.
                    </div>
                </div>

                <div class="form-group">
                    <label for="region">Region</label>
                    <select
                        class="form-control"
                        id="region"
                        name="region"
                        {% if not is_first_setup %}disabled{% endif %}
                        required
                    >
                        <option value="">-- Select a region --</option>
                        {% for r in regions %}
                            <option value="{{ r }}" {% if user.region == r %}selected{% endif %}>{{ r }}</option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">Required. Choose your region.</small>
                </div>

                <div class="form-group">
                    <label for="profilePicture">Profile Picture</label>
                    <input
                        type="file"
                        class="form-control-file"
                        id="profilePicture"
                        name="profilePicture"
                        accept="image/jpeg,image/png"
                        {% if not is_first_setup %}disabled{% endif %}
                    />
                    <small class="form-text text-muted">Optional. JPG or PNG only. Keep file size reasonable.</small>
                    {% if user.profile_picture_path %}
                        <div class="mt-2">
                            <small class="form-text text-muted">Current picture:</small>
                            <img src="{{ url_for('static', filename=user.profile_picture_path) }}" alt="Profile" class="profile-picture-medium" style="margin-top: 8px; display: block;" />
                        </div>
                    {% endif %}
                </div>

                <br />
                <button type="submit" class="btn btn-success btn-block" id="submitBtn" {% if not is_first_setup %}style="display: none;"{% endif %}>Save Account Information</button>
            </form>
        </div>

<script>
function enableEditMode() {
    document.getElementById('name').disabled = false;
    document.getElementById('dateOfBirth').disabled = false;
    document.getElementById('region').disabled = false;
    document.getElementById('profilePicture').disabled = false;
    document.getElementById('submitBtn').style.display = 'block';
    document.getElementById('editBtn').style.display = 'none';
    document.getElementById('cancelBtn').style.display = 'inline-block';
    document.getElementById('accountForm').classList.remove('form-disabled');
    document.getElementById('accountForm').classList.add('form-enabled');
}

function disableEditMode() {
    document.getElementById('name').disabled = true;
    document.getElementById('dateOfBirth').disabled = true;
    document.getElementById('region').disabled = true;
    document.getElementById('profilePicture').disabled = true;
    document.getElementById('submitBtn').style.display = 'none';
    document.getElementById('editBtn').style.display = 'inline-block';
    document.getElementById('cancelBtn').style.display = 'none';
    document.getElementById('accountForm').classList.remove('form-enabled');
    document.getElementById('accountForm').classList.add('form-disabled');
}

function validateAge() {
    const dobInput = document.getElementById('dateOfBirth').value;
    const ageError = document.getElementById('ageError');
    const submitBtn = document.getElementById('submitBtn');
    
    if (!dobInput) {
        ageError.style.display = 'none';
        return;
    }
    
    const dob = new Date(dobInput);
    const today = new Date();
    let age = today.getFullYear() - dob.getFullYear();
    const monthDiff = today.getMonth() - dob.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
        age--;
    }
    
    if (age < 18) {
        ageError.style.display = 'block';
        submitBtn.disabled = true;
    } else {
        ageError.style.display = 'none';
        submitBtn.disabled = false;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    validateAge();
});
</script>
{% endblock %}
