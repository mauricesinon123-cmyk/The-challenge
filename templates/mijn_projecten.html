{% extends "base.html" %}
{% block title %}Mijn Projecten{% endblock %}

{% block content %}
<style>
    .project-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }
    
    .project-content {
        flex: 1;
    }
    
    .project-buttons {
        margin-left: 15px;
        white-space: nowrap;
    }
    
    .edit-button {
        background-color: var(--light-green);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        margin-left: 5px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .edit-button:hover {
        background-color: var(--secondary-green);
        box-shadow: 0 4px 12px rgba(64, 145, 108, 0.3);
    }
    
    .delete-button {
        background-color: #d64045;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        margin-left: 5px;
        display: none;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .delete-button:hover {
        background-color: #c82333;
        box-shadow: 0 4px 12px rgba(200, 35, 51, 0.3);
    }
    
    .delete-button.show {
        display: inline-block;
    }
    
    .edit-form {
        display: none;
        margin-top: 10px;
        padding: 15px;
        background-color: var(--very-light-green);
        border-radius: 6px;
        border: 1px solid var(--lighter-green);
    }
    
    .edit-form.show {
        display: block;
    }
    
    .edit-form input,
    .edit-form textarea {
        margin-bottom: 10px;
        width: 100%;
        padding: 8px 12px;
        border: 2px solid var(--lighter-green);
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.2s ease;
        background-color: white;
        color: var(--text-dark);
    }
    
    .edit-form select {
        margin-bottom: 10px;
        width: 100%;
        padding: 8px 12px;
        border: 2px solid var(--lighter-green);
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.2s ease;
        background-color: white !important;
        color: var(--text-dark) !important;
    }
    
    .edit-form select option {
        color: var(--text-dark) !important;
        background-color: white !important;
        padding: 5px;
    }
    
    .edit-form select option:checked {
        background-color: var(--very-light-green) !important;
        color: var(--text-dark) !important;
    }
    
    .edit-form input:focus,
    .edit-form textarea:focus,
    .edit-form select:focus {
        outline: none;
        border-color: var(--light-green);
        box-shadow: 0 0 0 3px rgba(82, 183, 136, 0.1);
    }
    
    .edit-form-buttons {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }
    
    .save-button {
        background-color: var(--light-green);
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 6px;
        cursor: pointer;
        flex: 1;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .save-button:hover {
        background-color: var(--secondary-green);
        box-shadow: 0 4px 12px rgba(64, 145, 108, 0.3);
    }
    
    .cancel-edit-button {
        background-color: var(--lighter-green);
        color: var(--primary-green);
        border: none;
        padding: 10px 16px;
        border-radius: 6px;
        cursor: pointer;
        flex: 1;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .cancel-edit-button:hover {
        background-color: var(--light-green);
        color: white;
        box-shadow: 0 4px 12px rgba(82, 183, 136, 0.3);
    }
    
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .modal-overlay.show {
        display: flex;
    }
    
    .modal-content {
        background-color: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        max-width: 400px;
        width: 90%;
        border: 2px solid var(--very-light-green);
    }
    
    .modal-content h4 {
        margin-bottom: 1rem;
        color: var(--primary-green);
        font-weight: 600;
    }
    
    .modal-project-title {
        font-weight: 600;
        color: var(--primary-green);
        margin: 1rem 0;
        padding: 1rem;
        background-color: var(--very-light-green);
        border-radius: 6px;
    }
    
    .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }
    
    .modal-confirm {
        background-color: #d64045;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .modal-confirm:hover {
        background-color: #c82333;
        box-shadow: 0 4px 12px rgba(200, 35, 51, 0.3);
    }
    
    .modal-cancel {
        background-color: var(--lighter-green);
        color: var(--primary-green);
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .modal-cancel:hover {
        background-color: var(--light-green);
        color: white;
        box-shadow: 0 4px 12px rgba(82, 183, 136, 0.3);
    }
    
    .page-header {
        margin-bottom: 2.5rem;
    }
    
    .page-header h1 {
        color: var(--primary-green);
        font-weight: 600;
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }
    
    .page-header p {
        color: #666;
        font-size: 1.1rem;
        margin: 0;
    }
    
    .form-section {
        background-color: white;
        padding: 2rem;
        border-radius: 12px;
        border: 2px solid var(--very-light-green);
        margin-bottom: 2.5rem;
    }
    
    .form-section h3 {
        color: var(--primary-green);
        font-weight: 600;
        margin-bottom: 1.5rem;
    }
    
    .list-group-item {
        border: 2px solid var(--very-light-green);
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }
    
    .list-group-item strong {
        color: var(--primary-green);
    }
</style>

<div class="page-header text-center mb-5">
    <h1 class="display-4 font-weight-bold" style="color: var(--primary-green);">Mijn Projecten</h1>
    <p class="lead text-muted">Hier kunt u uw projecten beheren en nieuwe projecten toevoegen.</p>
</div>

<form method="POST" class="glass-card mb-5">
    <h3 class="mb-4">CreeÃ«r een nieuw project</h3>
    <div class="form-group">
        <label for="projectTitle">Project Titel</label>
        <input type="text" class="form-control" id="projectTitle" name="projectTitle" required>
    </div>
    <div class="form-group">
        <label for="projectText">Project Beschrijving</label>
        <textarea class="form-control" id="projectText" name="projectText" rows="3" required></textarea>
    </div>
    <div class="form-group">
        <label for="projectGroup">Kies de meest passende SDG (1-17)</label>
        <select class="form-control" id="projectGroup" name="projectGroup" required>
            
            <option value="1">SDG 1 - Armoede</option>
            <option value="2">SDG 2 - Honger</option>
            <option value="3">SDG 3 - Goede Gezondheid en Welzijn</option>
            <option value="4">SDG 4 - Kwaliteitsonderwijs</option>
            <option value="5">SDG 5 - Gendergelijkheid</option>
            <option value="6">SDG 6 - Schoon Water en Sanitair</option>
            <option value="7">SDG 7 - Betaalbare en Schone Energie</option>
            <option value="8">SDG 8 - Waardig Werk en Economische Groei</option>
            <option value="9">SDG 9 - Industrie, Innovatie en Infrastructuur</option>
            <option value="10">SDG 10 - Ongelijkheid Verminderen</option>
            <option value="11">SDG 11 - Duurzame Steden en Gemeenschappen</option>
            <option value="12">SDG 12 - Verantwoorde Consumptie en Productie</option>
            <option value="13">SDG 13 - Klimaatactie</option>
            <option value="14">SDG 14 - Leven in het Water</option>
            <option value="15">SDG 15 - Leven op het Land</option>
            <option value="16">SDG 16 - Vrede, Justitie en Sterke Instellingen</option>
            <option value="17">SDG 17 - Samenwerking</option>

            
        </select>
    </div>
    <button type="submit" class="btn btn-primary">Voeg project toe</button>
</form>

<div class="glass-card">
    <h3 class="mb-4">Uw Projecten</h3>
{% if user.projects %}
<ul class="list-group list-group-flush">
    {% for project in user.projects %}
    <li class="list-group-item border-0 mb-3 glass-card" style="background: rgba(255,255,255,0.5);">
        <div class="project-item">
            <div class="project-content">
                <div id="view-{{ project.id }}">
                    <strong>{{ project.title }}</strong> (Groep {{ project.group }}) - {{ project.date.strftime('%Y-%m-%d') }}
                    <div class="mt-2">{{ project.text }}</div>
                </div>
                <div class="edit-form" id="edit-form-{{ project.id }}">
                    <div class="form-group">
                        <label>Titel</label>
                        <input type="text" class="edit-title" id="title-{{ project.id }}" value="{{ project.title }}" />
                    </div>
                    <div class="form-group">
                        <label>Beschrijving</label>
                        <textarea class="edit-text" id="text-{{ project.id }}" rows="3">{{ project.text }}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Groep (1-16)</label>
                        <select class="edit-group" id="group-{{ project.id }}">
                            {% for i in range(1, 17) %}
                            <option value="{{ i }}" {% if project.group == i %}selected{% endif %}>{{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="edit-form-buttons">
                        <button type="button" class="save-button" data-project-id="{{ project.id }}">Opslaan</button>
                        <button type="button" class="cancel-edit-button" data-project-id="{{ project.id }}">Annuleren</button>
                    </div>
                </div>
            </div>
            <div class="project-buttons">
                <button type="button" class="edit-button" data-project-id="{{ project.id }}">Bewerken</button>
                <button type="button" class="delete-button" data-project-id="{{ project.id }}" data-project-title="{{ project.title }}">Verwijderen</button>
            </div>
        </div>
    </li>
    {% endfor %}
</ul>
{% else %}
<p>Nog geen projecten.</p>
{% endif %}
</div>

<div class="modal-overlay" id="deleteModal">
    <div class="modal-content">
        <h4>Project Verwijderen</h4>
        <p>Weet u zeker dat u dit project wilt verwijderen?</p>
        <div class="modal-project-title" id="modalProjectTitle"></div>
        <div class="modal-buttons">
            <button class="modal-cancel" onclick="closeDeleteModal()">Annuleren</button>
            <button class="modal-confirm" onclick="confirmDelete()">Bevestigen</button>
        </div>
    </div>
</div>

<script>
let deleteProjectId = null;

// Schakel de bewerkingsmodus in voor een specifiek project
function enableEditMode(button, projectId) {
    const deleteButton = button.nextElementSibling;
    deleteButton.classList.add('show');
    
    const viewDiv = document.getElementById('view-' + projectId);
    const editForm = document.getElementById('edit-form-' + projectId);
    
    // Verberg de weergave en toon het bewerkingsformulier
    button.style.display = 'none';
    viewDiv.style.display = 'none';
    editForm.classList.add('show');
    
    // Scroll naar het formulier voor betere focus
    setTimeout(() => {
        editForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 50);
}

// Annuleer de bewerking en herstel de weergave
function cancelEdit(projectId) {
    const viewDiv = document.getElementById('view-' + projectId);
    const editForm = document.getElementById('edit-form-' + projectId);
    // Zoek de bewerkknop op basis van het data-attribuut
    const editButton = document.querySelector(`.edit-button[data-project-id="${projectId}"]`);
    const deleteButton = editButton.nextElementSibling;
    
    editButton.style.display = 'inline-block';
    viewDiv.style.display = 'block';
    editForm.classList.remove('show');
    deleteButton.classList.remove('show');
}

// Sla de wijzigingen van het project op via een POST verzoek
function saveProject(projectId) {
    const title = document.getElementById('title-' + projectId).value.trim();
    const text = document.getElementById('text-' + projectId).value.trim();
    const group = document.getElementById('group-' + projectId).value;
    
    // Controleer of alle velden zijn ingevuld
    if (!title || !text || !group) {
        alert('Alle velden zijn verplicht!');
        return;
    }
    
    // Verstuur de gewijzigde gegevens naar de server
    fetch('/edit-project', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            projectId: projectId,
            title: title,
            text: text,
            group: group
        })
    }).then(response => response.json())
      .then(data => {
          if (data.success) {
              // Herlaad de pagina om de wijzigingen te tonen
              location.reload();
          } else {
              alert('Fout: ' + (data.message || 'Project kon niet worden opgeslagen'));
          }
      }).catch(error => {
          console.error('Error:', error);
          alert('Er is een fout opgetreden bij het opslaan van het project.');
      });
}

// Open de bevestigingsmodal voor verwijderen
function openDeleteModal(projectId, projectTitle) {
    deleteProjectId = projectId;
    document.getElementById('modalProjectTitle').textContent = projectTitle;
    document.getElementById('deleteModal').classList.add('show');
}

// Sluit de verwijder-modal
function closeDeleteModal() {
    deleteProjectId = null;
    document.getElementById('deleteModal').classList.remove('show');
}

// Bevestig de verwijdering van het project
function confirmDelete() {
    if (deleteProjectId) {
        fetch('/delete-project', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ projectId: deleteProjectId })
        }).then(response => {
            if (response.ok) {
                location.reload();
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('Er is een fout opgetreden bij het verwijderen van het project.');
            closeDeleteModal();
        });
    }
}

// Sluit modal bij klikken buiten de content
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteModal();
    }
});

// Event delegation voor alle knoppen in de projectenlijst
document.addEventListener('click', function(e) {
    const editBtn = e.target.closest('.edit-button');
    if (editBtn) {
        const projectId = editBtn.getAttribute('data-project-id');
        enableEditMode(editBtn, projectId);
    }
    
    const deleteBtn = e.target.closest('.delete-button');
    if (deleteBtn) {
        const projectId = deleteBtn.getAttribute('data-project-id');
        const projectTitle = deleteBtn.getAttribute('data-project-title');
        openDeleteModal(projectId, projectTitle);
    }
    
    const saveBtn = e.target.closest('.save-button');
    if (saveBtn) {
        const projectId = saveBtn.getAttribute('data-project-id');
        saveProject(projectId);
    }
    
    const cancelBtn = e.target.closest('.cancel-edit-button');
    if (cancelBtn) {
        const projectId = cancelBtn.getAttribute('data-project-id');
        cancelEdit(projectId);
    }
});
</script>
{% endblock %}
